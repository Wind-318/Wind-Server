# 访问地址：https://windserver.top
# 服务端架设流程
- 需要自行安装并启动 MySQL 和 Redis（版本 5.0 以上） 服务端，需要配置 golang 环境（1.15.6 以上版本）
- 需要自行添加 https 证书（或关闭 https）；
- 根据需求自行填写各个服务节点的 config.go 文件；
- 各个服务节点运行方式：进入文件夹，执行 go run main.go；
- 运行顺序(Version-0.6)：启动 registerCenter 服务注册中心，启动 database 数据库服务，启动其它各服务（顺序任意），最后启动 main 程序；
- 流程图(Version-0.6)：
  ```mermaid
  graph TB;
  MySQL-->服务注册中心;
  Redis-->服务注册中心;

  爬虫服务1-->服务注册中心;
  算法服务1-->服务注册中心;
  邮件服务1-->服务注册中心;
  用户服务1-->服务注册中心;
  订阅服务1-->服务注册中心;
  存储服务1-->服务注册中心;

  负载均衡-->爬虫服务3
  负载均衡-->算法服务3
  负载均衡-->邮件服务3
  负载均衡-->用户服务3
  负载均衡-->订阅服务3
  负载均衡-->存储服务3
  负载均衡-->MySQL
  负载均衡-->Redis

  subgraph 服务集群;
    爬虫服务3-->爬虫服务2-->爬虫服务1
    算法服务3-->算法服务2-->算法服务1
    邮件服务3-->邮件服务2-->邮件服务1
    用户服务3-->用户服务2-->用户服务1
    订阅服务3-->订阅服务2-->订阅服务1
    存储服务3-->存储服务2-->存储服务1
    end

  subgraph 数据库;
    MySQL
    end
    
  subgraph 缓存;
    Redis
    end

  主程序-->负载均衡
  ```

## 服务调用图
- #### 服务注册、发现
```mermaid
sequenceDiagram
  各服务->>服务注册中心:服务注册
  服务注册中心->>MySQL:注册服务到数据库
  各服务->>服务注册中心:拉取已注册服务到本地缓存
  服务注册中心->>MySQL:读取服务信息
  服务注册中心->>各服务:返回服务 IP 和端口号
  loop
    服务注册中心->>各服务:定时拉取已注册服务到本地缓存
  end
```

- #### 注册：
```mermaid
sequenceDiagram
  主程序->>主程序:发起请求，获取验证码
  主程序->>Redis:检查验证码是否已发送
  主程序->>主程序:告知用户验证码已发送 / 未发送
  主程序->>Redis:投送消息（用户邮箱）
  邮件服务->>Redis:读取消息，发送邮件

  主程序->>用户模块:发起注册请求，获取信息
  用户模块->>用户模块:检查信息合法性
  用户模块->>算法模块:发送密码加密
  算法模块->>用户模块:返回加密字符串
  用户模块->>MySQL:存入数据库
  用户模块->>主程序:返回注册结果
  主程序->>主程序:文件夹初始化，创建个人页面
```

- #### 存储调用过程：
```mermaid
sequenceDiagram
  participant 主程序
  participant 用户模块
  participant 存储模块
  participant Redis
  participant MySQL

  主程序->>用户模块:权限验证
  用户模块->>主程序:返回结果
  主程序->>存储模块:检查剩余空间是否足够
  存储模块->>Redis:从缓存中读取用户剩余空间
  存储模块-->>MySQL:未命中则从数据库读取，再刷入缓存
  存储模块->>MySQL:减少用户剩余可用空间
  存储模块->>Redis:减少用户剩余可用空间
  存储模块-->>Redis:从 Redis 返回的值小于 0 时，空间不足，淘汰缓存
  存储模块-->>MySQL:增加用户剩余可用空间（补偿过程）
  存储模块-->>Redis:等待 500 ms，再次删除缓存
  存储模块->>主程序:返回结果
  
  主程序->>主程序:保存文件到本地
```

# TODO
- [ ] 代码重构；
  - [ ] bbs 板块（早期版本，等待重制）；
  - [ ] 数据库集群；
  - [ ] redis 集群；
  - [ ] 检查服务可用性；
  - [ ] bug-fix；
- [ ] 日志表；
- [x] 存储系统更新；
  - [ ] 增加删除功能；
  - [x] 修改空间计算方式；
  - [ ] 显示剩余存储空间；
  - [x] 添加一键下载功能；
- [x] 每季度新番列表导航；
  - [ ] 已有追踪策略优化；
- [ ] bbs 板块重制（目前主要功能是写 markdown 进行记录）；
  - [ ] 去中心化；
  - [ ] ~~类似贴吧的机制？~~
  - [ ] 增加文章权重系统；
  - [ ] 分区管理；
  - [ ] 分区管理员机制；
- [ ] 收藏导航板块重制；
  - [ ] ~~还没想好具体机制；~~
- [ ] 用户模块扩展
  - [ ] 注册机制可自定义为开放注册或邀请注册或关闭注册（当前状态）（只能后台添加）；
  - [ ] 完善等级机制；
  - [ ] 完善权限系统；
  - [ ] 消息提醒；
  - [ ] 好友功能；
  - [ ] 更完善的用户个人界面？；
- [ ] 积分（货币）系统；
  - [ ] ~~增加银行（借贷与存款？）~~
  - [ ] ~~增加股票市场（模拟盘）（实时绑定 A 股？）~~
- [ ] 增加排序方式；
- [ ] 增加资源板块；
- [ ] 消息推送机制优化（长期）；
- [ ] 前端页面美化（长期）、移动端适配；
- [ ] 其它横向和纵向内容（机制）扩展（未定）；
# 版本更新说明
## 0.6 版本计划一览：
- 代码重构；
- 特性修复；
## 0.6.0
- 清除了历史记录，缩减仓库体积；
- 每日签到获得积分（随机获得，下限 3，上限 15）；
- 增加登录校验；
- 增加密码强度验证；
- 更新密码加密规则；
- 增加 IP 短时间内访问次数限制；
- ~~增加樱花动漫二号线路；（炸）~~
- 修复了新番追踪丢失的特性；
- 修复了存储模块在并发情况下对用户使用空间判定过少的特性；
- 修复了在不同月份的同一日签到判定为同一天的特性；
## 0.5.1
- 支持新建文件夹、按文件夹分类存放等功能；
- 支持图片批量上传；
- 支持存储空间分配；
## 0.5.0
- 增加存储板块；
## 0.4.3
- 增加樱花动漫线路；
## 0.4.2
- 修改选取策略为倒序选取；
## 0.4.1
- 新增追踪更新策略；
## 0.4.0
- 增加动漫板块；
- 增加检索动漫的功能；
- 添加跳转到可观看地址功能；
- 添加动漫简介;
- 增加分页功能；
- 添加多线路地址；
## 0.3.4
- 积分制试行；
## 0.3.3.2
- 修复部分特性；
## 0.3.3.1
- 修复更改标题后标题不改变的特性；
- 将新建文章时原地跳转到页面的行为修改为打开新窗口并跳转；
## 0.3.3 
- 支持头像修改；
- 更多注释；
## 0.3.2 
- 导航栏优化，目前导航栏默认为展开状态；
## 0.3.1 
- 增加查找文章功能；
- 修复了部分~~问题~~特性；
## 0.3.0 
- ~~更新~~ 发展为个人（多用户）网站（已暂时关闭注册功能）；
- 支持增加、删除、修改文章；
- 文章及评论都支持 markdown 格式且支持实时预览；
- 可以添加收藏的网站；
- 增加订阅推送数据表，当前可以选择推送股市相关消息，每天 6 点和 18 点会推送 10 条新闻链接到邮箱中；
- 还未开放订阅方式，当前只能在数据库中手动添加；
## 0.2.0 
- 订阅后自动推送（每天 6 点和 18 点，一次 10 条）；
- ~~需要在 infomation.go 中更改配置；~~
## 0.1.0 
- ~~需要自行配置数据库表，账号密码存储在 MySQL 中；~~
- 默认一次推送 ~~20~~ （10）条消息， 可以自行修改；
- 验证码由 Redis 缓存 ~~5 分钟~~（2 分钟）后过期，需要重新发送；
- ~~使用 go 标准日志库记录错误；~~
- ~~配置信息在 infomation.go 文件中~~